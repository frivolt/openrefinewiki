Reconciliation is a semi-automated process of matching text names to database IDs (keys). This is semi-automated because in some cases, machine alone is not sufficient and human judgement is essential. For example, given "Ocean's Eleven" as the name of a film, should it be matched to

* the original 1960 "Ocean's Eleven" ([[Wikidata item Q464933|https://www.wikidata.org/wiki/Q464933]]), or
* the 2001 remake "Ocean's Eleven" starring George Clooney ([[Wikidata item Q205447|https://www.wikidata.org/wiki/Q205447]])?

While we talk about "databases" here, perhaps a more accurate term would be "name registries". And conceptually, "reconciliation" isn't a new concept. In some fields, it's being done all the time. For example, when the police gets a name of a suspect, they run the name through their databases of known felons. More details about the suspect (e.g., race, height, last known address) would help the police narrow down the suspect among several database matches.

You can use OpenRefine to perform reconciliation of names in your data against any database that exposes a web service following this [[Reconciliation Service API|Reconciliation Service Api]] specification. One such database is [[Wikidata|https://www.wikidata.org/]], and in this document we will use it as our example service.


==Basics==

Givan a column containing names, we can reconcile those names against Wikidata. To do so, invoke the column's drop-down menu and pick //Reconcile// > //Start reconciling//. If you want to reconcile only some cells in that column, then use filters and facets to isolate them first.

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_column.png|Screenshot of the reconciliation menu}}

In the Reconcile dialog box, pick //Wikidata Reconciliation Service// on the left. That service comes by default, but you can install more services (see below to get a version of this service in your language).

There are a few options to configure the reconciliation process, which will help you get more reliable matches. These options are covered in the next sections. To start the reconciliation process, click the  //Start Reconciling// button.

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_start.png|Screenshot of the reconciliation dialog}}

This process will take a while depending on how much data you have. Currently, the Wikidata reconciliation service processes about 3 rows per second.

When the process is done, you will see that the reconciliation data in the cells.
* Either the cell was successfully matched: it displays a single dark blue link. In this case, the reconciliation is confident that the match is correct: you should not have to check it manually.

  {{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_match.png|(Screenshot of a matched item)}}
* Or a few candidates are displayed, together with their reconciliation score, with light blue links. You need to pick manually the correct one. For each matching decision you make, you have two options:Â either match this cell only ({{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_single_match.png|button to perform a single match}}), or also use the same identifier for all other cells containing the same unreconciled value ({{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_bulk_match.png|button to perform a multiple match}}).

  {{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_disambig.png|(Screenshot of an unmatched item)}}

In addition to changing the ways the reconciled cells are displayed, OpenRefine also automatically creates two facets for you to use to filter the cells based on the reconciliation data. One is a numeric facet for the reconciliation scores of the best candidates of the cells. Higher scores mean better matches. You could filter for the higher scores, and approve them all in bulk (invoking that column's drop-down menu and using the //Reconcile// > //Actions// submenu).

There is also the //judgment// facet, which lets you filter for the cells that haven't been matched (pick "None" in the facet). As you process each cell, its judgment changes from "None" to "Matched" and it disappears from the view, because it no longer fits the facet's selection.

==Restricting matches by type==

One simple way to improve the quality of the matches is to restrict them to a given type. If your dataset contains universities, then you know that "Heidelberg" does not refer to the [[city of Heidelberg (Q2966)|https://www.wikidata.org/wiki/]] but rather the [[university of Heidelberg (Q151510)|https://www.wikidata.org/wiki/Q151510]].

In Wikidata, types are items themselves. For instance, the [[university of Ljubljana (Q1377)|https://www.wikidata.org/wiki/Q1377]] has type [[public university (Q875538)|https://www.wikidata.org/wiki/Q875538]], which is witnessed by a statement on [[Q1377|https://www.wikidata.org/wiki/Q1377]] using the [[instance of (P31)|https://www.wikidata.org/wiki/Property:P31]] property.

Types are organized into an ontology, by specifying which types are subclasses of the others, using the [[subclass of (P279)|https://www.wikidata.org/wiki/Property:P279]] property. For instance, [[public university (Q875538)|https://www.wikidata.org/wiki/Q875538]] is a subclass of [[university (Q3918)|https://www.wikidata.org/wiki/Q3918]].

{{https://tools.wmflabs.org/openrefine-wikidata/static/explanation_types_wikidata.svg|(diagram explaining types in Wikidata)}}

One useful tool to visualize the subclasses of a given type is the [[Wikidata generic tree visualizer|https://tools.wmflabs.org/wikidata-todo/tree.html]]. For instance, here are [[all the subclasses of educational institution (Q2385804)|https://tools.wmflabs.org/wikidata-todo/tree.html?q=2385804&rp=279]].

The reconciliation dialog allows you to select a type for your rows. This will restrict the matches to items which
are instances of any subclass of the given type. For instance, if you select [[public institution (Q875538)|https://www.wikidata.org/wiki/Q875538]], then [[university of Ljubljana (Q1377)|https://www.wikidata.org/wiki/Q1377]] will be a possible match, because of the path depicted above.

By default, OpenRefine will propose you some types based on the first few items of your dataset. It is quite likely that these types will be too specific for your needs. You can specify a broader type that will encompass more items. For instance, if you have a dataset of universities, it might be better to pick [[educational institution (Q2385804)|https://www.wikidata.org/wiki/Q2385804]] rather than [[university (Q3918)|https://www.wikidata.org/wiki/Q3918]], for instance if some entry happens to be marked as a [[college (Q189004)|https://www.wikidata.org/wiki/Q189004]] in Wikidata.

Some items are not marked as the instances of anything, because nobody has taken the time to add these statements yet. If you restrict the reconciliation to a type, these items will not appear in the results, except when no items of the given type could be found for the particular name. In this case, items with no type can be returned: they will have a low score and will not be matched automatically.

==Refining by property==

Names are ambiguous, and sometimes your dataset contains other columns that can help identify which item is being referred to. The reconciliation interface can be configured to take these columns into account in the matching scores. For instance, say you have a dataset of sportspeople with a column indicating which sport they play.

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_name_sport.png|(example dataset)}}

If you want to use the second column in the reconciliation process, you need to identify how this additional information is represented in Wikidata. So you need to find out which Wikidata property is used to link sportspeople to the sport they play. Looking at [[Usain Bolt (Q1189)|https://www.wikidata.org/wiki/Q1189]] it seems that [[sport (P641)|https://www.wikidata.org/wiki/Property:P641]] can be used for that.

In the reconciliation dialog, tick the box to include your column and bind it to the relevant Wikidata property.

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_name_sport_dialog.png|(dialog to bind a column to a property)}}

The reconciliation service will then fuzzy-match on both rows.

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_name_sport_disambiguated.png|(example dataset)}}

As you can see, the score is boosted when the sport matches. In the first row, there is a slight mismatch between the sport in the table ("rugby") and on Wikidata ("rugby league"), which explains why the first match does not reach the perfect score (100) and is therefore not matched automatically.

==Advanced usage: property paths==

Sometimes, the relation between the reconciled item and the disambiguating column is not direct: it is not represented as a property itself. Let us consider this dataset of cities:

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_city_country.png|(an example dataset with cities and country codes)}}

To fetch the country code from an item representing a city, you need to follow two properties. First, follow [[country (P17)|https://www.wikidata.org/wiki/Property:P17]] to get to the item for the country in which this city is located, then follow [[ISO 3166-1 alpha-2 code (P297)|https://www.wikidata.org/wiki/Property:P297]] to get the two-letter code string.

{{https://tools.wmflabs.org/openrefine-wikidata/static/sparql_path_1.svg|(an example dataset with cities and country codes)}}

This is supported by the reconciliation interface, with a syntax inspired by [[SPARQL property paths|https://www.w3.org/TR/sparql11-property-paths/]]: just type the sequence of property identifiers separated by slashes, such as **P17/P297**:

{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_city_country_dialog.png|(inputting a property path in the reconciliation interface)}}

This additional information allows to distinguish between namesakes, to some extent. As "Cambridge, US" is still ambiguous, there are multiple items with a perfect matching score, but "Oxford, GB" successfully disambiguates one particular city from its namesakes.
{{https://tools.wmflabs.org/openrefine-wikidata/static/screenshot_city_country_disambiguated.png|(the disambiguated dataset)}}

==Query-based Reconciliation==

**This section is outdated and will be updated soon.**

As a degenerate form of "reconciliation", you can get a column of database IDs to be "reconciled". It's "degenerate" because the process isn't ambiguous since you already have IDs. The process of "reconciliation" here only involves fetching more data for those IDs (such as the official names corresponding to those IDs).

Right now OpenRefine only supports this kind of "query-based reconciliation" against Freebase. In the Reconcile dialog box, pick Freebase Query-based Reconciliation on the left. Your data can contain Freebase IDs, GUIDs, Wikipedia IDs, or keys in certain namespaces. For example, if you have country 2-letter ISO codes, you can reconcile against the namespace ISO 3166-1.

Note that you might have to encode your data into property Freebase keys before performing query-based reconciliation. Use the mqlKeyQuote() function documented [[GREL-String-Functions]].

== Keep all the suggestions made ==
To keep all suggestion made by the reconciliation service and not match against the best one:
# Before starting reconciliation un-check option Auto-match candidates with high confidence in Reconcile dialog (it's at the bottom). 
## After reconciliation you should be able to see all three suggested reconciliation candidates. This step is optional - it is just for you to see what will be extracted.
# After reconciliation click on the reconciled column and choose Add column based on this column.
##Put following expression in the Expression field if you want the value: {{{cell.recon.candidates[0].name}}}
##if you want link to Freebase - usually it is Freebase mid: {{{cell.recon.candidates[0].id}}}
##To get all off the IDs at the same time use the expression: {{{cell.recon.candidates.join(',')}}} , which will give you a comma separated list of all the IDs.  Then use the command "Split multi-valued cells" to split the identifiers into individual rows.
# If you then use reconcile against Freebase using the Freebase identifier option, you'll get the names and links that all you to use "Add column from Freebase" to get any other property values which are of interest.

==Language settings for Wikidata reconciliation==
You can install a version of the Wikidata reconciliation service that uses your language.

First, you need to find your language code: this is the first letters in the domain name of your Wikipedia (for instance "fr" if your Wikipedia is [[https://fr.wikipedia.org/wiki/]]).

Then, open the reconciliation dialog and click //Add Standard Service//. The URL is
{{{https://tools.wmflabs.org/openrefine-wikidata/fr/api}}}
where "fr" is replaced by your language code.

When reconciling using this interface, items and properties will be displayed in your language if a translation is available. The matching score of the reconciliation is not influenced by your choice of language: items are matched by considering all labels and keeping the best possible match. So the language of your dataset is irrelevant to the choice of the language for the reconciliation interface.

== Additional Resources ==
See also: 
* Recon section in the [[Variables]] page. 
* The different Data Sources available for [[Reconcilable-Data-Sources]]